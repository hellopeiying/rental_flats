<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Demo: Get started with the Isochrone API</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Mapbox GL JS -->
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.css" rel="stylesheet" />
  <!-- Mapbox Assembly -->
  <link href="https://api.mapbox.com/mapbox-assembly/v1.3.0/assembly.min.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-assembly/v1.3.0/assembly.js"></script>
  <!-- Google Maps JavaScript API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA88hjs974huI09CkBTVH4Ax7hRvmvw33c&callback=initMap" async defer></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="absolute fl my24 mx24 py24 px24 bg-gray-faint round">
    <form id="params">
      <h4 class="txt-m txt-bold mb6">Choose a travel mode:</h4>
      <div class="mb12 mr12 toggle-group align-center">
        <label class="toggle-container">
          <input name="profile" type="radio" value="walking" />
          <div class="toggle toggle--active-null toggle--null">Walking</div>
        </label>
        <label class="toggle-container">
          <input name="profile" type="radio" value="cycling" checked />
          <div class="toggle toggle--active-null toggle--null">Cycling</div>
        </label>
        <label class="toggle-container">
          <input name="profile" type="radio" value="driving" />
          <div class="toggle toggle--active-null toggle--null">Driving</div>
        </label>
        <label class="toggle-container">
          <input name="profile" type="radio" value="transit" />
          <div class="toggle toggle--active-null toggle--null">Public Transport</div>
        </label>
      </div>
      <h4 class="txt-m txt-bold mb6">Choose a maximum duration:</h4>
      <div class="mb12 mr12 toggle-group align-center">
        <label class="toggle-container">
          <input name="duration" type="radio" value="10" checked />
          <div class="toggle toggle--active-null toggle--null">10 min</div>
        </label>
        <label class="toggle-container">
          <input name="duration" type="radio" value="20" />
          <div class="toggle toggle--active-null toggle--null">20 min</div>
        </label>
        <label class="toggle-container">
          <input name="duration" type="radio" value="30" />
          <div class="toggle toggle--active-null toggle--null">30 min</div>
        </label>
      </div>
    </form>
  </div>
  <script>
    function initMap() {
      mapboxgl.accessToken = 'pk.eyJ1IjoicGVpeWluZ3VvZSIsImEiOiJjbHQzNTdydm8wdWFxMmpyejFkOTBqcHp0In0.ccp_lnjUYUuZ21yP8auFPg';

      const map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/peiyinguoe/clucsbsg800pp01pic4vfb1jj', // custom style
        center: [103.8198, 1.3521], // center on Singapore
        zoom: 11.5 // starting zoom
      });

      // Google Maps Distance Matrix API setup
      const googleMapsClient = new google.maps.DistanceMatrixService();

      // Create variables to use in getIso()
      const urlBase = 'https://api.mapbox.com/isochrone/v1/mapbox/';
      let profile = 'cycling';
      let minutes = 10;
      let selectedPoint = null;

      // When a user changes the value of profile or duration by clicking a button, change the parameter's value and make the API query again
      document.getElementById('params').addEventListener('change', (event) => {
        if (event.target.name === 'profile') {
          profile = event.target.value;
        } else if (event.target.name === 'duration') {
          minutes = event.target.value;
        }
        getIso(selectedPoint);
      });

      map.on('load', () => {
        // Add the isochrone mapbox layer
        map.addSource('iso', {
          type: 'geojson',
          data: {
            type: 'FeatureCollection',
            features: []
          }
        });

        map.addLayer(
          {
            id: 'isoLayer',
            type: 'fill',
            // Use "iso" as the data source for this layer
            source: 'iso',
            layout: {},
            paint: {
              // The fill color for the layer is set to a light purple
              'fill-color': '#5a3fc0',
              'fill-opacity': 0.3
            }
          },
          'poi-label'
        );
       
        // Add a click event listener to the map for the tileset points
        map.on('click', "rental-blocks-geocoded", async (e) => {
          selectedPoint = e.features[0].geometry.coordinates;
          getIso(selectedPoint);
        });
      });

      // Create a function that sets up the Isochrone API query then makes an fetch call
      async function getIso(coordinates) {
        if (!coordinates) return;

        let data;
        if (profile === 'transit') {
          // Use Google Maps Distance Matrix API for public transport
          googleMapsClient.getDistanceMatrix({
            origins: [`${coordinates[1]},${coordinates[0]}`],
            destinations: [`${coordinates[1]},${coordinates[0]}`], // Using same coordinates for origin and destination to get travel time to itself
            travelMode: 'TRANSIT',
            transitOptions: {
              modes: ['BUS', 'RAIL', 'SUBWAY', 'TRAIN', 'TRAM']
            },
            durationInTraffic: true,
            unitSystem: google.maps.UnitSystem.METRIC,
            drivingOptions: {
              departureTime: new Date()
            }
          }, (response, status) => {
            if (status === 'OK') {
              // Process response
              const duration = response.rows[0].elements[0].duration.value / 60; // Duration in minutes
              data = {
                type: 'FeatureCollection',
                features: [
                  {
                    type: 'Feature',
                    geometry: {
                      type: 'Point',
                      coordinates: coordinates
                    },
                    properties: {
                      travel_mode: 'transit',
                      duration: duration
                    }
                  }
                ]
              };
              map.getSource('iso').setData(data);
            } else {
              // Handle error
              console.error('Error fetching data from Google Maps Distance Matrix API');
            }
          });
        } else {
          // Use Mapbox Isochrone API for other travel modes
          const query = await fetch(
            `${urlBase}${profile}/${coordinates[0]},${coordinates[1]}?contours_minutes=${minutes}&polygons=true&access_token=${mapboxgl.accessToken}`,
            { method: 'GET' }
          );
          data = await query.json();
          map.getSource('iso').setData(data);
        }
      }
    }
  </script>
</body>
</html>
